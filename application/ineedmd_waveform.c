//*****************************************************************************
//
// ineedmd_waveform.c - waveform application for the patient EKG data processing
//
// Copyright (c) notice
//
//*****************************************************************************
#ifndef __INEEDMD_WAVEFORM_C__
#define __INEEDMD_WAVEFORM_C__
//*****************************************************************************
// includes
//*****************************************************************************
#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include "utils_inc/error_codes.h"
#include "board.h"
#include "ineedmd_bluetooth_radio.h"
#include "driverlib/rom.h"
#include "driverlib/rom_map.h"
#include "app_inc/ineedmd_command_protocol.h"

#include "app_inc/ineedmd_waveform.h"

//*****************************************************************************
// defines
//*****************************************************************************
#define NO_TEST_PAT 0x00

/******************************************************************************
* variables
******************************************************************************/
static bool bTest_Mode = false;
static int Test_Mode_Waveform = NO_TEST_PAT;

static int sample_data [164][8] =
  {
      {-5647,   -4853,   -2684,   551,   -5404,   -4191,   5368,   1544  },
      {-5353,   -4412,   -625,   2463,   -5846,   -4044,   6250,   3456  },
      {-3368,   -2132,   3199,   5625,   -2684,   -1691,   5809,   5368  },
      {-574,   1324,   9301,   10772,   625,   1397,   4706,   8015  },
      {4353,   6471,   16654,   16728,   6875,   6544,   1397,   10956  },
      {11044,   12721,   23566,   21728,   13346,   10735,   -2941,   13015  },
      {16926,   17868,   28787,   25478,   19669,   13897,   -7279,   14559  },
      {20750,   20221,   31581,   27243,   23860,   15368,   -10074,   15147  },
      {21118,   18824,   28419,   23272,   21360,   16029,   -11176,   10515  },
      {18691,   15147,   19154,   13787,   13640,   12279,   -10221,   3456  },
      {12368,   8309,   9669,   6728,   5699,   3382,   -4706,   2574  },
      {3765,   -147,   3199,   4596,   3640,   -4779,   1765,   6544  },
      {-59,   -3456,   772,   3419,   3419,   -7059,   3897,   7206  },
      {-941,   -3824,   -699,   1581,   1434,   -6471,   4191,   5147  },
      {-1456,   -4191,   -2316,   -699,   -331,   -5588,   3309,   2279  },
      {-1382,   -4118,   -3493,   -2390,   625,   -4632,   1250,   0  },
      {-1382,   -3676,   -3713,   -2978,   -37,   -4118,   956,   -1176  },
      {-1382,   -3235,   -3640,   -3125,   -699,   -3603,   956,   -1691  },
      {-1750,   -3529,   -3566,   -2831,   -2022,   -3235,   1397,   -1471  },
      {-2485,   -4265,   -3419,   -2463,   -3566,   -3088,   2059,   -735  },
      {-2632,   -4706,   -3566,   -2757,   -2831,   -2794,   1912,   -882  },
      {-2559,   -4559,   -3860,   -3125,   -3125,   -3088,   1544,   -1103  },
      {-2485,   -4412,   -4154,   -3566,   -2757,   -3456,   1029,   -1544  },
      {-2044,   -3603,   -4081,   -3640,   -2243,   -4191,   1250,   -1544  },
      {-1382,   -2647,   -3713,   -3346,   -2684,   -4118,   1765,   -1176  },
      {-1162,   -2500,   -3787,   -3566,   -2022,   -3382,   1544,   -1250  },
      {-1750,   -3015,   -4228,   -4228,   -1801,   -3235,   1029,   -1765  },
      {-2485,   -3971,   -4154,   -4154,   -1507,   -3015,   1103,   -1618  },
      {-2044,   -3824,   -3051,   -3125,   -2316,   -1765,   2353,   -441  },
      {-1162,   -2721,   -2390,   -2463,   -2390,   -1765,   2794,   74  },
      {-1456,   -2868,   -2757,   -2978,   -1287,   -2059,   1912,   -662  },
      {-1676,   -3162,   -3051,   -3272,   -1875,   -2353,   1397,   -1176  },
      {-1603,   -3235,   -2757,   -2904,   -2757,   -2426,   1765,   -735  },
      {-1162,   -2868,   -2610,   -2757,   -3787,   -2500,   1912,   -735  },
      {-1015,   -2794,   -2610,   -2831,   -2831,   -2132,   1324,   -956  },
      {-1603,   -3382,   -2978,   -3199,   -1287,   -2500,   809,   -1250  },
      {-1015,   -2574,   -2610,   -2904,   -1728,   -1912,   1029,   -882  },
      {-426,   -1471,   -2169,   -2610,   -1287,   -1397,   1103,   -588  },
      {-868,   -1765,   -1949,   -2390,   -1728,   -1765,   1250,   -368  },
      {-426,   -1324,   -1654,   -2096,   -3787,   -2574,   1397,   -147  },
      {-353,   -1176,   -1654,   -2096,   -2978,   -2574,   1029,   -221  },
      {-500,   -1250,   -1360,   -1949,   -1581,   -1838,   662,   -294  },
      {-647,   -1544,   -1066,   -1949,   -1654,   -1471,   515,   -368  },
      {-426,   -1691,   -551,   -1581,   -478,   -809,   662,   -74  },
      {-206,   -1618,   37,   -1066,   -551,   -441,   956,   294  },
      {-132,   -1765,   551,   -772,   -1654,   -441,   882,   515  },
      {-132,   -1250,   846,   -551,   -1801,   -956,   662,   662  },
      {15,   -588,   919,   -478,   -1213,   -1397,   368,   809  },
      {603,   221,   1066,   -331,   -1507,   -809,   74,   735  },
      {1044,   662,   1507,   -110,   -1949,   -74,   74,   882  },
      {971,   441,   2316,   551,   -2096,   221,   368,   1618  },
      {603,   -147,   2316,   551,   -1581,   74,   74,   1618  },
      {750,   0,   2610,   699,   -1287,   -515,   -221,   1765  },
      {824,   441,   3051,   993,   -551,   -221,   -662,   1838  },
      {824,   662,   3346,   1360,   -404,   74,   -956,   2059  },
      {971,   809,   3934,   1801,   551,   588,   -1176,   2426  },
      {897,   662,   4449,   2316,   772,   1029,   -1397,   2868  },
      {676,   221,   4890,   2684,   625,   1176,   -1618,   3162  },
      {1485,   1324,   5772,   3419,   1213,   1250,   -1912,   3750  },
      {1926,   2279,   6728,   4081,   1360,   1250,   -2206,   4191  },
      {2662,   3088,   7316,   4522,   1213,   1985,   -2426,   4412  },
      {3176,   3676,   8051,   4963,   2316,   2941,   -2868,   4779  },
      {3471,   3971,   8566,   5184,   2463,   2941,   -3235,   5000  },
      {3250,   3824,   8860,   5331,   3051,   3088,   -3603,   5221  },
      {3397,   3971,   9154,   5478,   4301,   4191,   -4118,   5368  },
      {2735,   3603,   9007,   5478,   4963,   4706,   -4485,   5294  },
      {2221,   3015,   8419,   5257,   4375,   4044,   -4853,   5000  },
      {2074,   3015,   7684,   4963,   3346,   3456,   -5147,   4485  },
      {2294,   3088,   7390,   4743,   3346,   3235,   -5221,   4191  },
      {2441,   3015,   6581,   3934,   3419,   3603,   -5368,   3382  },
      {2074,   2574,   5331,   3272,   3419,   3456,   -5515,   2500  },
      {1559,   1838,   3934,   2316,   3199,   2721,   -5368,   1691  },
      {1412,   1544,   2904,   1360,   2537,   1985,   -5000,   1029  },
      {1412,   1324,   1581,   257,   1213,   1324,   -4853,   147  },
      {1118,   882,   625,   -699,   404,   515,   -4485,   -515  },
      {824,   441,   110,   -1581,   331,   294,   -4191,   -956  },
      {676,   74,   -257,   -2243,   110,   -147,   -3676,   -1176  },
      {529,   -294,   -846,   -2831,   -331,   -735,   -3162,   -1471  },
      {382,   -588,   -1507,   -3346,   -625,   -1103,   -2721,   -1618  },
      {162,   -956,   -2022,   -3934,   -699,   -1397,   -2500,   -1985  },
      {-574,   -1838,   -2978,   -4596,   -1066,   -2279,   -2574,   -2721  },
      {-1235,   -2500,   -3934,   -4449,   -37,   -2206,   -3015,   -3309  },
      {-1309,   -2647,   -4449,   -4154,   -184,   -2647,   -2721,   -3162  },
      {-500,   -1985,   -4816,   -3934,   -1581,   -2647,   -2059,   -2794  },
      {-132,   -1397,   -5257,   -3640,   -1801,   -2206,   -1324,   -2132  },
      {162,   -1250,   -5551,   -3272,   -1213,   -1618,   -662,   -1324  },
      {456,   -1250,   -5919,   -3346,   -1801,   -1765,   -441,   -1250  },
      {750,   -882,   -6213,   -3493,   -1360,   -1397,   -662,   -1471  },
      {162,   -1176,   -6801,   -3934,   -1140,   -2132,   -1176,   -1985  },
      {15,   -1176,   -6801,   -3713,   -1801,   -2794,   -882,   -1838  },
      {382,   -809,   -6581,   -3346,   -1654,   -1912,   -956,   -1765  },
      {824,   -515,   -5993,   -3125,   -1287,   -1029,   -956,   -1691  },
      {1118,   -221,   -5551,   -2684,   -1949,   -368,   -662,   -1544  },
      {1118,   -368,   -5478,   -2463,   -2169,   -74,   -735,   -1691  },
      {676,   -882,   -5625,   -2831,   -1875,   -515,   -1029,   -1912  },
      {382,   -1324,   -5625,   -2978,   -1728,   -662,   -1250,   -1985  },
      {382,   -1618,   -5551,   -3051,   -1434,   -588,   -1324,   -2059  },
      {456,   -1691,   -5478,   -3051,   -1360,   -882,   -1324,   -2279  },
      {603,   -1691,   -5257,   -2684,   -1507,   -1471,   -1324,   -2353  },
      {897,   -1471,   -5037,   -2390,   -2243,   -1691,   -1250,   -2279  },
      {1044,   -1618,   -5037,   -2316,   -2831,   -2426,   -1176,   -2353  },
      {1191,   -1838,   -5110,   -2243,   -2757,   -2500,   -1250,   -2500  },
      {1265,   -1985,   -4816,   -2022,   -1949,   -2059,   -1471,   -2647  },
      {1485,   -1765,   -4228,   -1434,   -772,   -1324,   -1397,   -2353  },
      {1853,   -1765,   -4007,   -1066,   -1287,   -1324,   -1176,   -2353  },
      {1926,   -1985,   -3787,   -993,   -2537,   -1838,   -956,   -2279  },
      {1412,   -2500,   -3860,   -993,   -1875,   -1765,   -1029,   -2279  },
      {1485,   -2426,   -3566,   -772,   -1728,   -1471,   -1103,   -2279  },
      {1853,   -2279,   -3346,   -772,   -1949,   -1029,   -1176,   -2426  },
      {2809,   -1691,   -2831,   -625,   -2169,   -662,   -1029,   -2206  },
      {3397,   -1176,   -2390,   -404,   -2537,   -735,   -662,   -1838  },
      {3618,   -1103,   -2169,   -478,   -2463,   -1103,   -588,   -1691  },
      {3471,   -1250,   -2243,   -625,   -1801,   -882,   -882,   -1912  },
      {3250,   -1471,   -2022,   -699,   -2463,   -956,   -735,   -1765  },
      {3544,   -1324,   -1654,   -551,   -2904,   -1397,   -515,   -1397  },
      {3985,   -956,   -1434,   -772,   -3125,   -882,   -441,   -1324  },
      {4500,   -441,   -1287,   -919,   -3125,   -735,   -515,   -1324  },
      {4721,   -221,   -993,   -1066,   -3051,   -809,   -441,   -1250  },
      {4574,   -441,   -993,   -1213,   -2537,   -809,   -588,   -1324  },
      {4206,   -809,   -919,   -1287,   -2316,   -956,   -809,   -1397  },
      {3985,   -1103,   -919,   -1507,   -2757,   -956,   -1103,   -1618  },
      {4206,   -1103,   -551,   -1287,   -2096,   -515,   -1176,   -1397  },
      {4279,   -1029,   -184,   -1360,   -1654,   -368,   -1250,   -1103  },
      {3985,   -1103,   37,   -1507,   -2610,   -221,   -1176,   -882  },
      {3838,   -1103,   184,   -993,   -2316,   294,   -1471,   -882  },
      {3838,   -1176,   404,   110,   -1434,   809,   -1838,   -882  },
      {3544,   -1471,   331,   184,   -919,   1250,   -2574,   -1103  },
      {3985,   -1029,   625,   110,   -1287,   1765,   -2941,   -956  },
      {4868,   -294,   772,   257,   -2463,   1544,   -2721,   -662  },
      {5088,   74,   625,   625,   -2684,   2059,   -2868,   -588  },
      {5162,   147,   772,   1140,   -1581,   2721,   -3235,   -662  },
      {4941,   147,   772,   993,   -846,   3456,   -3676,   -1103  },
      {4794,   0,   699,   551,   -919,   2794,   -3676,   -1324  },
      {5162,   441,   1140,   404,   -1581,   2868,   -3750,   -1250  },
      {5676,   882,   1581,   404,   -1287,   2794,   -4191,   -1397  },
      {5824,   882,   1801,   257,   -404,   3015,   -4926,   -1544  },
      {5750,   735,   1728,   -37,   -37,   3603,   -5515,   -1765  },
      {5456,   368,   1581,   -257,   404,   3676,   -5662,   -1838  },
      {4868,   -147,   1434,   -331,   478,   2353,   -5294,   -1765  },
      {4647,   -368,   1140,   -625,   110,   882,   -4853,   -1912  },
      {4206,   -662,   110,   -1360,   -110,   0,   -4779,   -2353  },
      {4059,   -809,   -404,   -1581,   331,   -294,   -4485,   -2353  },
      {4721,   -294,   -478,   -1434,   772,   441,   -4338,   -2206  },
      {5235,   221,   -404,   -1140,   625,   662,   -3824,   -1912  },
      {5456,   515,   -331,   -1066,   -1507,   662,   -2868,   -1618  },
      {5015,   147,   -846,   -1581,   -2390,   662,   -2500,   -2059  },
      {4426,   -368,   -1360,   -2096,   -2022,   956,   -2426,   -2426  },
      {4721,   -74,   -1287,   -2022,   -2390,   1103,   -1985,   -2279  },
      {4279,   -294,   -1287,   -1875,   -2904,   735,   -1471,   -1912  },
      {3176,   -1324,   -1581,   -1949,   -1949,   -147,   -1397,   -1912  },
      {2000,   -2206,   -2022,   -2463,   -2904,   -1985,   -1250,   -2206  },
      {2441,   -1691,   -2243,   -2757,   -3934,   -1691,   -1250,   -2500  },
      {3324,   -588,   -1801,   -2316,   -4816,   -956,   -882,   -1985  },
      {3618,   -368,   -1287,   -1581,   -4963,   -956,   -441,   -1324  },
      {3176,   -1103,   -1434,   -1581,   -3125,   -1397,   -515,   -1324  },
      {2588,   -1618,   -2096,   -2096,   -2463,   -1471,   -956,   -1912  },
      {1926,   -1838,   -2684,   -2610,   -3125,   -588,   -1324,   -2353  },
      {2221,   -1471,   -2537,   -2463,   -3566,   809,   -1250,   -2132  },
      {1853,   -1912,   -2463,   -2316,   -4154,   1397,   -1324,   -1838  },
      {309,   -3235,   -2904,   -2463,   -3787,   1324,   -1176,   -1544  },
      {-868,   -4191,   -2978,   -2096,   -4301,   515,   -74,   -441  },
      {-941,   -4191,   -2684,   -1434,   -5772,   147,   1324,   662  },
      {-1088,   -3824,   -2243,   -772,   -6875,   -368,   2500,   1324  },
      {-1162,   -3382,   -993,   551,   -6287,   -441,   3162,   2721  }


  };

//*****************************************************************************
// external variables
//*****************************************************************************

//*****************************************************************************
// enums
//*****************************************************************************

//*****************************************************************************
// structures
//*****************************************************************************

//*****************************************************************************
// external functions
//*****************************************************************************

//*****************************************************************************
// function declarations
//*****************************************************************************

//*****************************************************************************
// functions
//*****************************************************************************

/******************************************************************************
* name:
* description:
* param description:
* return value description:
******************************************************************************/
int iIneedmd_waveform_enable_TestSignal(int which_waveform)
{

  set_system_speed (INEEDMD_CPU_SPEED_FULL_INTERNAL);
  bTest_Mode = true;
  Test_Mode_Waveform = which_waveform;
  return 1;
}

/******************************************************************************
* name:
* description:
* param description:
* return value description:
******************************************************************************/
int iIneedmd_waveform_disable_TestSignal(void)
{
  set_system_speed (INEEDMD_CPU_SPEED_DEFAULT);
  bTest_Mode = false;
  Test_Mode_Waveform = NO_TEST_PAT;
  return 1;
}

/******************************************************************************
* name:
* description:
* param description:
* return value description:
******************************************************************************/
bool iIneedmd_is_test_running(void)
{
  return bTest_Mode;
}

/* ineedmd_measurement_ramp
 * Sends a set of measurement ramps... full scale..
 *
 * This function simply outputs a set of saw tooth measurement packets to test the display.
 */
void ineedmd_test_waveform(void)
{
#define PACKET_LENGTH 0x14

  static uint8_t record_no = 0;
  static uint8_t slow_down = 0;
  char test_packet[PACKET_LENGTH];


  if (slow_down > 3)
  {
  if ( record_no > 163 )
  {
    record_no = 0;
  }

  test_packet[0x00] = 0x9C;
  test_packet[0x01] = 0x04;
  test_packet[0x02] = PACKET_LENGTH;
  test_packet[PACKET_LENGTH-1] = 0xC9;


    //V6 measurements
    test_packet[0x03] = (char) ((0xff00 & sample_data[record_no][0]) >>8);
    test_packet[0x04] = (char) ((0x00ff & sample_data[record_no][0]) >>0);
    //V5 measurements
    test_packet[0x05] = (char) ((0xff00 & sample_data[record_no][1]) >>8);
    test_packet[0x06] = (char) ((0x00ff & sample_data[record_no][1]) >>0);
    //V4 measurements
    test_packet[0x07] = (char) ((0xff00 & sample_data[record_no][2]) >>8);
    test_packet[0x08] = (char) ((0x00ff & sample_data[record_no][2]) >>0);
    //V3 measurements
    test_packet[0x09] = (char) ((0xff00 & sample_data[record_no][3]) >>8);
    test_packet[0x0a] = (char) ((0x00ff & sample_data[record_no][3]) >>0);
    //I measurements
    test_packet[0x0b] = (char) ((0xff00 & sample_data[record_no][4]) >>8);
    test_packet[0x0c] = (char) ((0x00ff & sample_data[record_no][4]) >>0);
    //II measurements
    test_packet[0x0d] = (char) ((0xff00 & sample_data[record_no][5]) >>8);
    test_packet[0x0e] = (char) ((0x00ff & sample_data[record_no][5]) >>0);
    //V2 measurements
    test_packet[0x0f] = (char) ((0xff00 & sample_data[record_no][6]) >>8);
    test_packet[0x10] = (char) ((0x00ff & sample_data[record_no][6]) >>0);
    //V1 measurements
    test_packet[0x11] = (char) ((0xff00 & sample_data[record_no][7]) >>8);
    test_packet[0x12] = (char) ((0x00ff & sample_data[record_no][7]) >>0);

    record_no++;
    slow_down=0;

    ineedmd_radio_send_frame((uint8_t *)test_packet, PACKET_LENGTH);
  }
  slow_down++;


//    }
//  }
}

void ineedmd_measurement_ramp(void)
{
#define PACKET_LENGTH 0x14

  uint16_t uiSys_Tick_value = 0;//MAP_SysTickValueGet();
  int value_of_measurement;
  unsigned char highbyte = 0;
  unsigned char lowbyte = 0;
  char test_packet[PACKET_LENGTH];

  eBSP_Get_Current_ms(&uiSys_Tick_value);
  uiSys_Tick_value = uiSys_Tick_value<<6;
  value_of_measurement = (int) (uiSys_Tick_value - 0x8000);
  lowbyte = (char)(0x00ff & value_of_measurement);
  highbyte = (char)(0x00ff & (value_of_measurement >> 8));

  test_packet[0x00] = 0x9C;
  test_packet[0x01] = 0x04;
  test_packet[0x02] = PACKET_LENGTH;
  test_packet[PACKET_LENGTH-1] = 0xC9;


      //V6 measurements
      test_packet[0x03] = highbyte;
      test_packet[0x04] = lowbyte;
      //V5 measurements
      test_packet[0x05] = highbyte;
      test_packet[0x06] = lowbyte;
      //V4 measurements
      test_packet[0x07] = highbyte;
      test_packet[0x08] = lowbyte;
      //V3 measurements
      test_packet[0x09] = highbyte;
      test_packet[0x0a] = lowbyte;
      //I measurements
      test_packet[0x0b] = highbyte;
      test_packet[0x0c] = lowbyte;
      //II measurements
      test_packet[0x0d] = highbyte;
      test_packet[0x0e] = lowbyte;
      //V2 measurements
      test_packet[0x0f] = highbyte;
      test_packet[0x10] = lowbyte;
      //V1 measurements
      test_packet[0x11] = highbyte;
      test_packet[0x12] = lowbyte;

      ineedmd_radio_send_frame((uint8_t *)test_packet, PACKET_LENGTH);

}



/******************************************************************************
* name:
* description:
* param description:
* return value description:
******************************************************************************/
int iIneedmd_waveform_process(void)
{
  bool bDid_sys_tick = false;
  static uint32_t count_ticks;

  if(( bTest_Mode == true))
  {
    bDid_sys_tick = bWaveform_did_timer_tick();


    if(bDid_sys_tick == true)
    {
      if (Test_Mode_Waveform == NO_TEST_PAT)
       {

       }
      else if  (Test_Mode_Waveform == TRIANGLE_TEST_PAT)
      {
        ineedmd_measurement_ramp();
      }
      else if  (Test_Mode_Waveform == SQUARE_TEST_PAT)
      {
        ineedmd_measurement_ramp();
      }
      else if  (Test_Mode_Waveform == WAVEFORM_TEST_PAT)
      {
        ineedmd_test_waveform();
      }
            count_ticks++;
    }
    if(count_ticks >= 10000)
    {
      ineedmd_send_status();
      count_ticks = 0;
    }
  }
  return 1;
}

int iIneedmd_sysinfo_process(void)
{ return 1;
}

/******************************************************************************
* name:
* description:
* param description:
* return value description:
******************************************************************************/

#endif //__INEEDMD_WAVEFORM_C__
